<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>잘살아보세 가계부 2026 - Pro Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; letter-spacing: -0.025em; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 1.5rem; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.03); }
        .nav-btn { transition: all 0.2s ease; position: relative; cursor: pointer; }
        .nav-btn.active { color: #2563eb; background: #eff6ff; }
        .nav-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 16px; height: 4px; background: #2563eb; border-radius: 2px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Loading Overlay */
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(4px); transition: opacity 0.3s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased min-h-screen pb-10">
    <!-- 초기 로딩 화면 -->
    <div id="loadingOverlay">
        <div class="spinner mb-4"></div>
        <p class="font-bold text-slate-500">클라우드 연결 확인 중...</p>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter flex items-center gap-3">
                    <span class="p-2 bg-blue-600 rounded-2xl shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </span>
                    잘살아보세 2026 <span class="text-blue-600">Pro</span>
                </h1>
                <div class="flex items-center gap-2 mt-2">
                    <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                    <p id="statusMsg" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">연결 대기 중</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <div id="userProfile" class="hidden flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-slate-200 shadow-sm">
                    <img id="userImg" class="w-6 h-6 rounded-full" src="" alt="">
                    <span id="userDisplayName" class="text-xs font-bold text-slate-700"></span>
                </div>
                <button id="googleLoginBtn" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold shadow-sm hover:bg-slate-50 transition-all flex items-center gap-2">
                    <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Google로 로그인하여 연동하기
                </button>
                <button id="logoutBtn" class="hidden text-slate-400 text-xs font-bold hover:text-rose-500 transition-colors">로그아웃</button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
            <div class="glass-card p-6 border-l-8 border-l-emerald-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">총 수입</p>
                <h2 id="totalInc" class="text-2xl font-black text-slate-800 tracking-tight">0원</h2>
            </div>
            <div class="glass-card p-6 border-l-8 border-l-rose-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">총 지출</p>
                <h2 id="totalExp" class="text-2xl font-black text-slate-800 tracking-tight">0원</h2>
            </div>
            <div class="glass-card p-6 border-l-8 border-l-blue-600 bg-blue-600 text-white shadow-blue-200 shadow-xl">
                <p class="text-[10px] font-black text-blue-100 uppercase tracking-widest mb-1">현재 잔액</p>
                <h2 id="totalBal" class="text-2xl font-black tracking-tight">0원</h2>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainUI" class="space-y-8 opacity-50 pointer-events-none transition-opacity">
            <section class="glass-card p-8">
                <h3 class="text-lg font-black text-slate-800 mb-6">✍️ 거래 내역 추가</h3>
                <form id="addForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label class="text-[10px] font-black text-slate-400 ml-1">구분/범주</label>
                        <div class="flex gap-2">
                            <select id="type" class="w-1/3 bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm font-bold">
                                <option value="지출">지출</option>
                                <option value="수입">수입</option>
                            </select>
                            <select id="cat" class="w-2/3 bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm font-bold">
                                <option value="식비">식비</option>
                                <option value="생활">생활</option>
                                <option value="교통">교통</option>
                                <option value="쇼핑">쇼핑</option>
                                <option value="급여">급여</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-1">날짜</label>
                        <input type="date" id="date" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-1">내용 및 금액</label>
                        <div class="flex gap-2">
                            <input type="text" id="memo" placeholder="내역" class="w-1/2 bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm font-bold">
                            <input type="number" id="amt" placeholder="금액" class="w-1/2 bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm font-bold">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 text-white font-black py-3.5 rounded-xl hover:bg-blue-600 transition-colors">기록 저장</button>
                </form>
            </section>

            <section class="glass-card overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase">날짜</th>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase">범주</th>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase">내역</th>
                            <th class="p-4 text-[10px] font-black text-slate-400 uppercase text-right">금액</th>
                            <th class="p-4"></th>
                        </tr>
                    </thead>
                    <tbody id="listBody" class="divide-y divide-slate-50"></tbody>
                </table>
            </section>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl opacity-0 transition-opacity font-bold text-sm pointer-events-none z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : "well-live-2026";

        let currentUser = null;
        let unsubscribe = null;

        // --- UI Elements ---
        const loginBtn = document.getElementById('googleLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileArea = document.getElementById('userProfile');
        const mainUI = document.getElementById('mainUI');
        const statusDot = document.getElementById('statusDot');
        const statusMsg = document.getElementById('statusMsg');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // --- Auth Logic ---
        const handleAuthChange = async (user) => {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.style.display = 'none', 300);

            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                profileArea.classList.remove('hidden');
                document.getElementById('userImg').src = user.photoURL || 'https://ui-avatars.com/api/?name=User';
                document.getElementById('userDisplayName').textContent = user.displayName || '사용자';
                
                mainUI.classList.remove('opacity-50', 'pointer-events-none');
                statusDot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                statusMsg.textContent = user.isAnonymous ? "임시 저장 모드 (연동 안됨)" : "클라우드 실시간 연동 중";
                
                startSync();
            } else {
                currentUser = null;
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                profileArea.classList.add('hidden');
                mainUI.classList.add('opacity-50', 'pointer-events-none');
                statusDot.className = "w-2 h-2 rounded-full bg-slate-300";
                statusMsg.textContent = "로그인 필요";
                
                if (unsubscribe) unsubscribe();
                render([]);
            }
        };

        const login = async () => {
            const provider = new GoogleAuthProvider();
            try {
                // Canvas 환경에서는 팝업이 차단될 수 있으므로 예외 처리가 중요함
                await signInWithPopup(auth, provider);
                showToast("로그인 성공! 동기화를 시작합니다.");
            } catch (err) {
                console.error(err);
                showToast("로그인 실패. 팝업 차단을 해제하거나 다시 시도해주세요.");
            }
        };

        const logout = async () => {
            if (confirm("로그아웃 하시겠습니까? 기기 간 연동이 중단됩니다.")) {
                await signOut(auth);
                location.reload(); // 상태 초기화를 위해 새로고침
            }
        };

        // --- Data Sync ---
        const startSync = () => {
            if (!currentUser) return;
            const path = `/artifacts/${appId}/users/${currentUser.uid}/records`;
            const q = collection(db, path);
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // JS에서 날짜순 정렬 (RULE 2: 복합 쿼리 지양)
                records.sort((a, b) => new Date(b.date) - new Date(a.date));
                render(records);
            }, (err) => {
                console.error(err);
                showToast("데이터 연동 오류 발생");
            });
        };

        const render = (records) => {
            const body = document.getElementById('listBody');
            let inc = 0, exp = 0;

            body.innerHTML = records.map(r => {
                const isInc = r.type === '수입';
                const val = Number(r.amt) || 0;
                if (isInc) inc += val; else exp += val;

                return `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 text-xs font-bold text-slate-400">${r.date}</td>
                        <td class="p-4 text-xs font-bold text-slate-600">${r.cat}</td>
                        <td class="p-4 text-xs font-black text-slate-800">${r.memo}</td>
                        <td class="p-4 text-right font-black ${isInc ? 'text-emerald-500' : 'text-slate-900'}">
                            ${isInc ? '+' : '-'}${val.toLocaleString()}
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="window.del('${r.id}')" class="text-slate-300 hover:text-rose-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('totalInc').textContent = inc.toLocaleString() + '원';
            document.getElementById('totalExp').textContent = exp.toLocaleString() + '원';
            document.getElementById('totalBal').textContent = (inc - exp).toLocaleString() + '원';
        };

        // --- Actions ---
        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const data = {
                type: document.getElementById('type').value,
                cat: document.getElementById('cat').value,
                date: document.getElementById('date').value,
                memo: document.getElementById('memo').value,
                amt: Number(document.getElementById('amt').value),
                ts: Date.now()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'records'), data);
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
                showToast("저장되었습니다! 모든 기기에 반영됩니다.");
            } catch (err) {
                showToast("저장 실패");
            }
        };

        window.del = async (id) => {
            if (confirm("내역을 삭제하시겠습니까?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'records', id));
            }
        };

        const showToast = (m) => {
            const t = document.getElementById('toast');
            t.textContent = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        };

        // --- Init ---
        loginBtn.onclick = login;
        logoutBtn.onclick = logout;
        document.getElementById('date').valueAsDate = new Date();

        // Start Auth Flow (RULE 3)
        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(() => {});
            }
            onAuthStateChanged(auth, handleAuthChange);
        };
        init();
    </script>
</body>
</html>
